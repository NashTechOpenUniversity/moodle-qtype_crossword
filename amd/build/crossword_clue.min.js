define("qtype_crossword/crossword_clue",["exports","qtype_crossword/crossword_question"],(function(_exports,_crossword_question){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.CrosswordClue=void 0;
/**
   * Crossword clue class, handle any action relative to clue.
   *
   * @module qtype_crossword/crossword_clue
   * @copyright 2022 The Open University
   * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
class CrosswordClue extends _crossword_question.CrosswordQuestion{constructor(options){super(options)}setUpClue(){let{words:words,readonly:readonly}=this.options;this.options.crosswordEl.closest(".qtype_crossword-grid-wrapper").querySelectorAll(".contain-clue .wrap-clue").forEach((el=>{const questionId=el.dataset.questionid;let word=words.find((o=>o.number===parseInt(questionId)));if(word){const inputEl=el.querySelector("input");inputEl.value+=this.makeUnderscore(word.length-inputEl.value.length),readonly||(inputEl.disabled=!1),this.addEventForClueInput(inputEl,word)}}))}addEventForClueInput(el,word){const{readonly:readonly}=this.options;let startSelection=0;readonly||(el.addEventListener("click",(e=>{let startIndex=e.target.selectionStart;startIndex>=word.length&&(startIndex=word.length-1),this.focusCellByStartIndex(startIndex,word),this.focusClue(),this.setStickyClue()})),el.addEventListener("focus",(e=>{e.target.dispatchEvent(new Event("click"))})),el.addEventListener("beforeinput",(e=>{"insertText"===e.inputType&&e.data&&this.handleInsertedCharacterToElement(e,e.data)})),el.addEventListener("input",(e=>{"deleteContentBackward"===e.inputType&&this.handleAndSyncDeletedStringToElement(e.target,e.target.value)})),el.addEventListener("keypress",(e=>{e.preventDefault(),this.handleInsertedCharacterToElement(e,e.key)})),el.addEventListener("compositionstart",(evt=>{const selection=evt.target.selectionStart;startSelection=selection})),el.addEventListener("compositionend",(evt=>{evt.preventDefault(),evt.stopPropagation();const{wordNumber:wordNumber}=this.options,selection=evt.target.selectionStart;let key=evt.data.normalize("NFKC"),currentSelection=startSelection;evt.target.setSelectionRange(selection,selection),key.split("").forEach((char=>{this.handleTypingData(evt,wordNumber,word,currentSelection,char)&&currentSelection++}))})),el.addEventListener("keyup",(event=>{event.preventDefault();const{words:words,wordNumber:wordNumber}=this.options,{key:key,target:target}=event;let{value:value}=target,isValidKey=!1,maxLength=parseInt(target.getAttribute("maxlength"));if([this.ARROW_LEFT,this.ARROW_RIGHT].includes(key)){isValidKey=!0;const startIndex=target.selectionStart,gEl=this.options.crosswordEl.querySelector("g[data-word*='(".concat(wordNumber,")'][data-letterindex='").concat(startIndex,"']"));gEl&&this.toggleHighlight(word,gEl)}if(key!==this.DELETE&&key!==this.BACKSPACE||this.handleAndSyncDeletedStringToElement(target,value),key===this.END||key===this.HOME){isValidKey=!0;let startIndex=0;const word=words.find((o=>o.number===parseInt(wordNumber)));if(!word)return;key===this.END&&(startIndex=word.length-1),this.syncFocusCellAndInput(target,startIndex)}!isValidKey&&startSelection>=maxLength&&(event.target.value=value.slice(0,maxLength))})),el.addEventListener("paste",(event=>{event.preventDefault();const{words:words,wordNumber:wordNumber}=this.options,word=words.find((o=>o.number===parseInt(wordNumber)));let selection=event.target.selectionStart,value=(event.clipboardData||window.clipboardData).getData("text");value=this.replaceText(value).normalize("NFKC"),""!==value&&value.split("").forEach((char=>{this.handleTypingData(event,wordNumber,word,selection,char)&&selection++}))})),el.addEventListener("keydown",(e=>{e.ctrlKey&&e.key.toLowerCase()===this.Z_KEY&&e.preventDefault(),e.key===this.ENTER&&e.preventDefault()})),el.addEventListener("cut",(event=>{const selectString=document.getSelection().toString(),startIndex=event.target.selectionStart;let{value:value}=event.target;value=value.substring(0,startIndex)+value.substring(startIndex+selectString.length)+this.makeUnderscore(selectString.length),event.target.value=value,event.clipboardData.setData("text/plain",selectString),event.preventDefault(),event.target.setSelectionRange(startIndex,startIndex),this.syncLettersByText(value,!1)})))}handleTypingData(evt,wordNumber,word,selectionIndex,char){const gelEl=this.options.crosswordEl.querySelector("g[data-word*='(".concat(wordNumber,")'][data-letterindex='").concat(selectionIndex,"']"));if(""===this.replaceText(char))return!1;gelEl&&(gelEl.querySelector("text.crossword-cell-text").innerHTML=char.toUpperCase(),this.bindDataToClueInput(gelEl,char.toUpperCase())),selectionIndex++;const nexEl=this.options.crosswordEl.querySelector("g[data-word*='(".concat(wordNumber,")'][data-letterindex='").concat(selectionIndex,"']"));return nexEl&&(this.toggleHighlight(word,nexEl),evt.target.setSelectionRange(selectionIndex,selectionIndex)),!0}focusCellByStartIndex(startIndex,word){let position=this.calculatePosition(word,startIndex);const rect=this.options.crosswordEl.querySelector("g rect[x='".concat(position.x,"'][y='").concat(position.y,"']"));rect&&(this.options.wordNumber=word.number,this.toggleHighlight(word,rect.closest("g")),this.updateLetterIndexForCells(word))}syncFocusCellAndInput(target,startIndex){const{wordNumber:wordNumber}=this.options,gEl=this.options.crosswordEl.querySelector("g[data-word*='(".concat(wordNumber,")'][data-letterindex='").concat(startIndex,"']"));target.setSelectionRange(startIndex,startIndex),gEl&&this.toggleFocus(gEl)}toggleFocus(gEl){const focused=this.options.crosswordEl.querySelector("g rect.crossword-cell-focussed");focused&&(focused.classList.remove("crossword-cell-focussed"),focused.classList.add("crossword-cell-highlighted")),gEl.querySelector("rect").classList.add("crossword-cell-focussed")}handleAndSyncDeletedStringToElement(target,value){const{words:words,wordNumber:wordNumber}=this.options,word=words.find((o=>o.number===parseInt(wordNumber)));if(!word)return;let startIndex=target.selectionStart;const selectionLength=word.length-value.length,underScore=this.makeUnderscore(selectionLength);target.value=[value.slice(0,startIndex),underScore,value.slice(startIndex)].join(""),this.syncLettersByText(target.value,!1),this.syncFocusCellAndInput(target,startIndex)}handleInsertedCharacterToElement(event,value){const{words:words,wordNumber:wordNumber}=this.options,word=words.find((o=>o.number===parseInt(wordNumber)));let startIndex=event.target.selectionStart;""!==(value=this.replaceText(value).normalize("NFKC"))&&this.handleTypingData(event,wordNumber,word,startIndex,value)}}_exports.CrosswordClue=CrosswordClue}));

//# sourceMappingURL=crossword_clue.min.js.map